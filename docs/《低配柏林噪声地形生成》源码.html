<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>《低配柏林噪声地形生成》源码</title>
    <!-- 引入highlight.js的样式文件 -->
    <link rel="stylesheet" href="https://azkbbys.github.io/code-viewer/files/default.min.css">
    <style>
        body {
            background-color: #000000;
        }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
        <button style="position: absolute; top: 10px;" onclick="copyCode()">复制</button>
        <button id="download-html" style="position: absolute; top: 10px; right: 65px;" onclick="downloadHTML()">下载HTML文件</button>
    </div>
    <div id='code-input'><p>
console.clear()
var shengcheng = false
var kadun = 0
var kadunnumber = 0

function random(min, max) {
   return Math.round(Math.random() * (max - min) + min)
}
function ave(a,b) {
   return Math.round((a+b)/2)
}
function ave_list(list){
    let sum = 0;
    for(let i=0;i<list.length;i++){
        sum+=list[i];
    }
    return Math.round(sum/list.length);
}
function smoothList(inputList, width) {
   let resultList = inputList.slice();  // 创建一个副本，以免修改原始列表

   for (let i = 0; i < inputList.length; i++) {
       let neighborsSum = inputList[i-1] + inputList[i+1];
       let beforeWidth = Math.max(0, i-width);
       let afterWidth = Math.min(inputList.length-1, i+width);
       neighborsSum += inputList[beforeWidth] + inputList[afterWidth];
       resultList[i] = neighborsSum / 4;  // 将当前项替换为相邻项和指定间隔项的平均值
   }

   return resultList;
}
async function setBlock(map){
    world.say('开始部署地图！')
    var xiangshu = 0
    for (let x = 0; x < 256; x++) {
        for (let z = 0; z < 256; z++) {
            for (let y = 0; y < 64; y++) {
                if(y<=map[xiangshu]-4){
                    voxels.setVoxel(x,y,z,'stone')
                }
                else if(y<=map[xiangshu]-1){
                    voxels.setVoxel(x,y,z,'dirt')
                }
                else if(y<=map[xiangshu]){
                    voxels.setVoxel(x,y,z,'grass')
                }
                else{
                    voxels.setVoxel(x,y,z,0)
                }
            }
            await sleep(1)
            xiangshu += 1
            world.say(`部署进度${xiangshu+1}/65536 当前卡顿指数${kadunnumber}`)
        }
    }
    world.say('随机生成地图完毕！')
    shengcheng=false
}

// 柏林噪声地形生成
async function randomMap(width, height, average, gaocha) {
    world.say('开始随机生成地图！')
    await sleep(1000)
    var nextValue = 0;
    let return_list = [];
    return_list.push(Math.min(height, Math.max(0, average + random(-gaocha, gaocha))));
    while (return_list.length < width) {
        if(ave_list(return_list)>=average+gaocha){
            nextValue = return_list[return_list.length - 1] + random(-gaocha, 0);
        }
        else if(ave_list(return_list)<average-gaocha){
            nextValue = return_list[return_list.length - 1] + random(0, gaocha);
        }
        else{
            nextValue = return_list[return_list.length - 1] + random(-gaocha, gaocha);
        }
        nextValue = Math.min(height, Math.max(0, nextValue));
        if(nextValue>0&&nextValue<=height){
            return_list.push(nextValue);
        }
    }
    while(return_list.length/width < width){
        return_list.push(return_list[return_list.length-1]+random(-gaocha, gaocha))
        while(return_list.length%width!=0){
            if(ave_list(return_list)>=average+gaocha){
                nextValue = ave(return_list[return_list.length-1],return_list[return_list.length-width])+random(-gaocha, 0)
            }
            else if(ave_list(return_list)<average-gaocha){
                nextValue = ave(return_list[return_list.length-1],return_list[return_list.length-width])+random(0, gaocha)
            }
            else{
                nextValue = ave(return_list[return_list.length-1],return_list[return_list.length-width]+random(-gaocha, gaocha))
            }
            if(nextValue>0&&nextValue<=height){
                return_list.push(nextValue);
                if(return_list.length%50==0){
                    world.say(`数据生成进度${return_list.length}/65536 当前卡顿指数${kadunnumber}`)
                    await sleep(1)
                }
            }
        }
    }
    return smoothList(return_list,width)
}


world.onPlayerJoin(async ({entity})=>{
    entity.player.spectator=true
    entity.player.cameraMode=GameCameraMode.FPS
})

world.onTick(({tick})=>{
    if(tick%160==0){
        if(shengcheng==false){
            world.say('地图现在处于空闲中，点击右键可以重新生成地图！')
        }
    }
})

world.onPress(async({button,entity})=>{
    if(button==='action1'){
        const result = await entity.player.dialog({
            type: GameDialogType.SELECT,
            title: '菜单',
            content:`选择`,
            options:[`${shengcheng==false?`开始生成地图`:`地图正在生成中，不要打扰哦~`}`]
        });
        if(!result || result.value === null){ 
            return; 
        }
        else if(result.value=='开始生成地图'){
            entity.result = await entity.player.dialog({
                type: GameDialogType.INPUT,
                title: '生成地图',
                content: `输入地图配置：平均高度（0<x<63且为整数） 最大高差（x>=0且为整数）\n使用空格隔开`,
                confirmText: '确认',
            });
            if(!entity.result || entity.result === null){ 
                return
            }
            else{
                let splited = entity.result.split(' ')
                let average = parseInt(splited[0])
                let gaocha = parseInt(splited[1])
                if(average>0&&average<63&&shengcheng==false&&gaocha>=0){
                    shengcheng = true
                    map = await randomMap(256, 64, average, gaocha);
                    setBlock(map)
                }
                else{
                    entity.player.directMessage(`输入不符合条件或地图已经开始生成`)
                }
            }
        }
    }
})

world.onTick(async({ tick,elapsedTimeMS }) => {
    if(tick%16==0){
        kadunnumber = elapsedTimeMS
        if(elapsedTimeMS > 640&&shengcheng==true){
            kadun+=1
            if(kadun>=2){
                world.say(`地图太卡了系统都看不下去了！正在重启！`)
                while(1){}
            }
        }
        else{
            kadun=0
        }
    }
})
    </p></div>
    <div id='code-type'><p>javascript</p></div>
    <div id="code-output" style="width: 100%; height: 500px;"></div>
    <!-- 引入highlight.js的脚本文件 -->
    <script src="https://azkbbys.github.io/code-viewer/files/highlight.min.js"></script>
    <script>
        var codeParam = document.getElementById("code-input").textContent;
        var typeParam = document.getElementById("code-type").textContent;
        document.getElementById('code-input').style.display = 'none';
        document.getElementById('code-type').style.display = 'none';
        // 乱码还原
        // codeParam = decodeURIComponent(codeParam);
        // 将&gt;和&lt;替换成>和<
        codeParam = codeParam.replace('&gt;', '>').replace('&lt;', '<');

        // 复制代码的函数
        function copyCode() {
            var codeText = document.getElementById("code-output").innerText;
            navigator.clipboard.writeText(codeText).then(function() {
                alert("代码已复制到剪贴板！");
            }, function(err) {
                console.error('无法复制代码: ', err);
            });
        }

        // 渲染代码的函数
        function renderCode() {
            // 获取输入代码和代码类型
            var codeInput = codeParam || ''; // 从URL参数中获取代码，如果没有则为空
            var codeType = typeParam || 'html'; // 从URL参数中获取代码类型，如果没有则默认为html
            // 如果类型是html，显示下载html按钮
            if (codeType === 'html') {
                document.getElementById("download-html").style.display = "block";
            } else {
                document.getElementById("download-html").style.display = "none";
            }

            // 如果输入内容为空，则显示提示
            if (codeInput.trim() === '') {
                document.getElementById("code-output").innerHTML = "<font color='white'>未提供内容...</font>";
            } else {
                // 转义HTML代码，替换特殊字符
                codeInput = codeInput.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                // 渲染代码
                var codeOutput = document.getElementById("code-output");
                codeOutput.innerHTML = '<pre><code class="language-' + codeType + '">' + codeInput + '</code></pre>';
                // 代码高亮
                hljs.highlightBlock(codeOutput.getElementsByTagName('code')[0]);
            }
        }

        // 初始化页面时渲染一次代码
        renderCode();

        function downloadHTML() {
            var content = document.getElementById("code-input").value;
            // 创建一个新的Blob对象
            var blob1 = new Blob([content], { type: 'text/html' });
            
            // 创建一个临时URL
            var url = URL.createObjectURL(blob1);

            // 创建一个链接并触发下载
            var link = document.createElement('a');
            link.href = url;
            link.download = 'myContent.html';
            link.click();
            // 释放URL对象
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>